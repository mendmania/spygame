{
  "rules": {
    "games": {
      "spyfall": {
        "rooms": {
          "$roomId": {
            // Anyone authenticated can read public room data
            ".read": "auth != null",
            
            "meta": {
              // Only room creator or existing players can write meta
              ".write": "auth != null && (
                !data.exists() || 
                data.child('createdBy').val() === auth.uid ||
                root.child('games/spyfall/rooms/' + $roomId + '/players/' + auth.uid).exists()
              )"
            },
            
            "state": {
              // Only server (admin) can write game state
              // For client-side, only host can trigger via server action
              ".write": "auth != null && 
                        root.child('games/spyfall/rooms/' + $roomId + '/players/' + auth.uid + '/isHost').val() === true"
            },
            
            "players": {
              "$playerId": {
                // Players can only write their own data
                ".write": "auth != null && auth.uid === $playerId",
                
                // Validate player data structure
                ".validate": "newData.hasChildren(['displayName', 'isHost', 'joinedAt']) &&
                              newData.child('displayName').isString() &&
                              newData.child('displayName').val().length > 0 &&
                              newData.child('displayName').val().length <= 20 &&
                              newData.child('isHost').isBoolean() &&
                              newData.child('joinedAt').isNumber()"
              }
            },
            
            "privatePlayerData": {
              // CRITICAL: Players can ONLY read their own private data
              "$playerId": {
                ".read": "auth != null && auth.uid === $playerId",
                // Only server (admin) can write private player data
                ".write": false
              }
            }
          }
        }
      },
      "werewolf": {
        "rooms": {
          "$roomId": {
            // Anyone authenticated can read public room data
            ".read": "auth != null",
            
            "meta": {
              // Only room creator or existing players can write meta (excluding selectedRoles during game)
              ".write": "auth != null && (
                !data.exists() || 
                data.child('createdBy').val() === auth.uid ||
                root.child('games/werewolf/rooms/' + $roomId + '/players/' + auth.uid).exists()
              )",
              
              "selectedRoles": {
                // Only host can change selected roles, and only during waiting phase
                ".write": "auth != null && 
                          root.child('games/werewolf/rooms/' + $roomId + '/players/' + auth.uid + '/isHost').val() === true &&
                          root.child('games/werewolf/rooms/' + $roomId + '/meta/status').val() === 'waiting'"
              }
            },
            
            "state": {
              // Only server (admin SDK) should write game state
              // Host can trigger via server action
              ".write": "auth != null && 
                        root.child('games/werewolf/rooms/' + $roomId + '/players/' + auth.uid + '/isHost').val() === true"
            },
            
            "players": {
              "$playerId": {
                // Players can only write their own data
                ".write": "auth != null && auth.uid === $playerId",
                
                // Validate player data structure
                ".validate": "newData.hasChildren(['displayName', 'isHost', 'joinedAt']) &&
                              newData.child('displayName').isString() &&
                              newData.child('displayName').val().length > 0 &&
                              newData.child('displayName').val().length <= 20 &&
                              newData.child('isHost').isBoolean() &&
                              newData.child('joinedAt').isNumber()"
              }
            },
            
            "privatePlayerData": {
              // CRITICAL: Players can ONLY read their own private data
              "$playerId": {
                ".read": "auth != null && auth.uid === $playerId",
                // Only server (admin SDK) can write private player data
                ".write": false
              }
            },
            
            "roles": {
              // Original role assignments - only server can write
              ".read": "auth != null",
              ".write": false
            },
            
            "currentRoles": {
              // Current roles after swaps - only server can write
              ".read": "auth != null",
              ".write": false
            },
            
            "centerCards": {
              // Center cards - only server can write, players cannot read during game
              ".read": "auth != null && root.child('games/werewolf/rooms/' + $roomId + '/meta/status').val() === 'ended'",
              ".write": false
            },
            
            "nightActions": {
              // Night actions - only server can write
              "$playerId": {
                ".read": "auth != null && auth.uid === $playerId",
                ".write": false
              }
            },
            
            "result": {
              // Game result - visible after game ends
              ".read": "auth != null && root.child('games/werewolf/rooms/' + $roomId + '/meta/status').val() === 'ended'"
            }
          }
        }
      }
    }
  }
}
